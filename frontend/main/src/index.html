<!-- Copyright (c) 2018-2022, RTE (http://www.rte-france.com)              -->
<!-- See AUTHORS.txt                                                       -->
<!-- This Source Code Form is subject to the terms of the Mozilla Public   -->
<!-- License, v. 2.0. If a copy of the MPL was not distributed with this   -->
<!-- file, You can obtain one at http://mozilla.org/MPL/2.0/.              -->
<!-- SPDX-License-Identifier: MPL-2.0                                      -->
<!-- This file is part of the OperatorFabric project.                      -->



<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Assistant CAB v1</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style title="opfabRootStyle">
    /** 
Style parameters is define using css variables --params

Just two variables are set here , the complete style is set by the navbar.component.ts using global-style.service.ts.

This two values are used when navbar is not yet loaded

These two parameters are place in this file as the style should have a title parameter (it 's not possible to give a name for the style in the angular.json file). 

*/


    :root {
      --opfab-bgcolor: #262f3d;
      --opfab-bgcolor-darker: #262f3d;
      --opfab-text-color: white;
      --opfab-input-text-color: white;
      --opfab-form-border-color: #606267;
      --opfab-form-label-text-color: #bababa;
    }
  </style>

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script>
    var selectedUseCase = "none";
    var token = window.localStorage.token;
    var opFabPort = "2002";
    var activeUser;
    var entities;
    var groups;
    var mapInitialized = false;
    var latitude;
    var longitude;
    var altitude;
    var authorizedUseCase;
    checkTokenToMatchUseCase();


    function checkTokenToMatchUseCase(){
      var request = new XMLHttpRequest();
      request.onreadystatechange= function () {
          if (request.readyState==4) {
            response = JSON.parse(request.responseText)
            activeUser = response.login;
            entities = response.entities;
            groups = response.groups;
            authorizedUseCase = entities[0];
            return entities[0];
          }
          console.log("token checked")
          // if (authorizedUseCase === undefined){
          //   window.location.reload();
          // }
      }
      // VM
      request.open("POST","/users/users/synchronizeWithToken", true);
      // local
      // request.open("POST", "http://192.168.211.95" + ":" + opFabPort + "/users/users/synchronizeWithToken", true);
      request.setRequestHeader("Accept","application/json");
      request.setRequestHeader("Authorization","Bearer "+token);
      request.send();
          
    }
    function selectUseCase(uc){
      if (uc == authorizedUseCase){
        grantedUseCase(authorizedUseCase);
      }else{
        alert("Error: You're not allowed to access this environment")
      }
    }

    function grantedUseCase(uc) {

      switch (uc) {
        case "RTE":
          console.log("RTE selected as use case");
          selectedUseCase = uc;
          document.getElementById("rte_checkboxes").hidden = false;
          document.getElementById("assist").hidden = false;
          document.getElementById("empty_block").hidden = true;
          document.getElementById("ctxImg").hidden = false;
          setInterval(() => {
            refreshCtxRTE();
          }, 30000);
          break;
        case "DA":
          getCoordinates();
          selectedUseCase = uc;
          console.log("Dassault selected as use case");
          document.getElementById("dassault_div").hidden = false;
          document.getElementById("dassault_assist").hidden = false;
          document.getElementById("dassault_assist_content_noContent").hidden = false;
          document.getElementById("dassaultBar").hidden = false;
          document.getElementById("dassaultBar2").hidden = false;
          document.getElementById("feed-content").style.position = "absolute";
          document.getElementById("opfab-navbar-menu-feed").text = "CAB Dassault";
          document.getElementById("opfab-navbar-menu-menu1").text = "";
          document.getElementById("opfab-navbar-menu-feed").style.borderBottomStyle = "none";
          document.getElementById("of_timeline").style.backgroundColor = "black";
          document.getElementById("ctx_div").classList += " dassault_ctx_div";
          document.getElementById("opfab-card-list").style.overflowY = "hidden";
          document.getElementById("notifs_DA").hidden = false;
          document.getElementById("bar").hidden = true;
          document.getElementById("bar2").hidden = true;
          document.getElementById("opfab-feed-filter-btn-filter").hidden = true;
          document.getElementById("of_timeline").style.zIndex = 5;
          document.getElementById("map").classList += " map_da";
          document.getElementById("notifContainer").innerHTML = document.getElementById("notifContainer").innerHTML.replace("Notifications","Failures");
          setInterval(() => {
            refreshCtxDA();
          }, 30000);
          
          opfabStyle.setCss(opfabStyle.NIGHT_STYLE);
          setDANotifications();
          break;
        case "ORANGE":
          selectedUseCase = uc;
          console.log("Orange selected as use case");
          document.getElementById("opfab-navbar-menu-feed").text = "CAB Orange";
          document.getElementById("opfab-navbar-menu-menu1").text = "";
          document.getElementById("opfab-navbar-menu-feed").style.borderBottomStyle = "none";
          break;
        case "SNCF":
          selectedUseCase = uc;
          console.log("SNCF selected as use case");
          document.getElementById("opfab-navbar-menu-feed").text = "CAB SNCF";
          document.getElementById("opfab-navbar-menu-menu1").text = "";
          document.getElementsByClassName('opfab-navbar')[0].style.backgroundColor = "#009AA6"
          document.getElementById("opfab-navbar-menu-feed").style.color = "white"
          document.getElementById("bar").hidden = true;
          document.getElementById("bar2").hidden = true;
          document.getElementById("opfab-navbar-menu-feed").style.borderBottomStyle = "none";
          document.getElementById("opfab-card-list").style.overflowY = "hidden";
          // document.getElementById("ctx_div").style.marginLeft = "440px";
          document.getElementById("assist").hidden = false;
          document.getElementById("assistOpTitle").classList += " sncf assist_sncf";
          document.getElementById("assistOpTitle").style.top = "80px";
          document.getElementById("feed-content").style.position = "absolute";
          document.getElementById("feed-content").style.marginTop = "0px";
          document.getElementById("feed-content").classList += " sncf";
          document.getElementById("ctx_div").classList+= " sncf sncf_ctx_div"
          document.getElementById("map").classList += " map_sncf";
          
          initMap("SNCF");
          break;

      }
      document.getElementById("homescreen").style = "display:none";
      document.getElementById("assistOpTitle").hidden = false;
    }

    function selectDassaultCtx(type) {
      switch (type) {
        case "dependances":
          document.getElementById("dependances").hidden = false;
          document.getElementById("synoptique").hidden = true;
          document.getElementById("carte").hidden = true;
          document.getElementById("map").hidden = true;
          document.getElementById("synoptic_back").hidden = true;
          break;
        case "carte":
          document.getElementById("dependances").hidden = true;
          document.getElementById("synoptique").hidden = true;
          document.getElementById("carte").hidden = false;
          document.getElementById("map").hidden = false;
          document.getElementById("synoptic_back").hidden = true;
          if (!mapInitialized) {
            initMap("Dassault");
            mapInitialized = true;
          }
          break;
        case "synoptique":
          document.getElementById("dependances").hidden = true;
          document.getElementById("synoptic_back").hidden = false;
          document.getElementById("synoptique").hidden = false;
          document.getElementById("carte").hidden = true;
          document.getElementById("map").hidden = true;
          break;

      }
    }
    
    function displayStats(value){
      switch (value){
        case 'stat':
          document.getElementById("synoptic_back").innerHTML = "<img class ='imgMarged' style='margin-top: 30px' src='assets/images/DA_stats.png'>";
          break;
        default : 
        document.getElementById("synoptic_back").innerHTML = "<b style='margin-top: 80px; color:white'>Nothing to show</b>";
          break;
      }
    }
    
    function setDANotifications(){
      try {
              setCardsForDA();
              setDescsForDA();
            } catch (error) {
            }
            try {
              setSeverityForDA();
            } catch (error) {
              
            }
    }
    if (selectedUseCase!= "DA"){
      setInterval(() => {
        setCardsSeverity();
      }, 5000);
    }

    function setCardsForDA() {
      var cards = document.getElementsByClassName("card");
      for (var card = 0; card < cards.length; card++) {
          cards[card].classList += " DA_Card light-card-detail-unselected-DA-MED";
        }
      }
          
    function setSeverityForDA() {
      var severities = document.getElementsByClassName("card-severity")
      for(var severity = 0;severities.length;severity++){
            severities[severity].textContent="";
        }
      }
    function setDescsForDA() {
        var descs = document.getElementsByClassName("p-1");
        for(var desc = 0;descs.length;desc++){
            descs[desc].textContent="";
        }
    }

    function setCardsSeverity() {
      var cards = document.getElementsByClassName("card");
      for (var card = 0; card < cards.length; card++) {
        cards[card].innerHTML = cards[card].innerHTML.replace("action ", "Sureté");
        cards[card].innerHTML = cards[card].innerHTML.replace("alarm ", "Sureté");
        cards[card].innerHTML = cards[card].innerHTML.replace("compliant ", "Routine ");
        cards[card].innerHTML = cards[card].innerHTML.replace("information ", "Routine ");
      }
      if (selectedUseCase == "DA"){
        setDANotifications();
      }
    }
    function refreshCtxRTE() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", "/cabcontext/api/v1/contexts?time=" + new Date().getTime(), false);
      xmlHttp.send(null);
      var response = JSON.parse(xmlHttp.responseText)[0].data.topology;
      document.getElementById("ctxImg").src = "data:image/png;base64," + response;
    };
    function refreshCtxDA() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", "/cabcontext/api/v1/contexts?time=" + new Date().getTime(), false);
      xmlHttp.send(null);
      var response = JSON.parse(xmlHttp.responseText)[0].data.topology;
      document.getElementById("ctxImg").src = "data:image/png;base64," + response;
    };
  </script>


  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <meta name="theme-color" content="#1976d2">
</head>

<body class="opfab-colors" id="bodyopfab" style="height:auto">

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script>
    function getCoordinates(){
      var request = new XMLHttpRequest();
      request.onreadystatechange= function () {
          if (request.readyState==4) {
            try {
            response = JSON.parse(request.responseText)
            //temporary fix for coordinates
              latitude = parseFloat(response[0].data.Latitude.replace("(","").replace(")","").replace(",",""));
              longitude = parseFloat(response[0].data.Longitude.replace("(","").replace(")","").replace(",",""));
              altitude = parseFloat(response[0].data.Altitude.replace("(","").replace(")","").replace(",",""));
            } catch (error) {
              latitude = 47.9948;
              longitude = -4.09245;
            }
          
            console.log(response)
          }
      }
      request.open("GET","/cabcontext/api/v1/contexts", true);
      request.setRequestHeader("Accept","application/json");
      request.setRequestHeader("Authorization","Bearer "+token);
      request.send();
    }
    function initMap(usecase) {

      switch (usecase) {
        case 'Dassault':
          mapZoom = 8;
          mapLayer = "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png";
          // valers par défaut si pas de contexte
          if(latitude === undefined || longitude === undefined){
              latitude = 47.9948;
              longitude = -4.09245;
          }
          var map = L.map('map', {
            center: [latitude,longitude],
            zoom: mapZoom
          });
          L.tileLayer(mapLayer, {
          }).addTo(map);
          let planeIcon = {
            iconUrl: "assets/images/plane_40x40.png",
            iconSize: [40, 40]
          }
          let myIcon3 = L.icon(planeIcon);
          let iconOptions3 = {
            draggable: false,
            icon: myIcon3
          }

          let planeMarker = new L.Marker([latitude, longitude], iconOptions3);
          planeMarker.addTo(map).bindPopup(iconOptions3.title)
          break;
        case 'SNCF':
          mapZoom = 17;
          initialLayer = "http://{s}.tile.osm.org/{z}/{x}/{y}.png";
          railwayLayer = "https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png";
          var map = L.map('map', {
            center: [47.9948, -4.09245],
            zoom: mapZoom
          });
          var baseLayer = L.tileLayer(initialLayer).addTo(map);
          var topLayer = L.tileLayer(railwayLayer).addTo(map);

          let customIcon = {
            iconUrl: "https://upload.wikimedia.org/wikipedia/commons/0/0e/Basic_red_dot.png",
            iconSize: [40, 40]
          }
          let customIcon2 = {
            iconUrl: "https://upload.wikimedia.org/wikipedia/commons/f/fd/Location_dot_grey.svg",
            iconSize: [40, 40]
          }
          let myIcon = L.icon(customIcon);


          let iconOptions = {
            title: "TGV 8872",
            draggable: false,
            icon: myIcon
          }
          let myIcon2 = L.icon(customIcon2);

          let iconOptions2 = {
            title: "TGV 8763",
            draggable: false,
            icon: myIcon2
          }




          let marker = new L.Marker([47.99501, -4.09445], iconOptions);
          marker.addTo(map).bindPopup(iconOptions.title)
            .openPopup();
          let marker2 = new L.Marker([47.9948, -4.09245], iconOptions2);
          marker2.addTo(map).bindPopup(iconOptions2.title)
            .openPopup();
          break;
      }


      console.log("map init OK")
      {

      }
    }

  </script>
  <div id="assistOpTitle" style="font-size: 18px; color: grey;position: absolute;top: 90px;" hidden>
  <!-- <div id="assistOpTitle" style="font-size: 18px; color: grey;position: absolute;left: 1178px;top: 90px;" hidden> -->
    <b id="assist" hidden>Assistance à l'opérateur</b>
    <b id="dassault_assist" hidden>Assistance</b>
    <div id="dassault_assist_content_noContent" hidden>
      <div id="da_bloc_content">
        <div id ="noevent_da"> No Event Selected<br>
          Please select an event<br>
          to have assistance</div>
          <div id="high_procedure" hidden>
            <img src="assets\images\endofprocedure_da.png">
          </div>
          <div id="pdv_da" hidden>
            <img src="assets\images\pdv_da.png">
          </div>
      </div>
    </div>
  </div>
  <of-root></of-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>

</html>