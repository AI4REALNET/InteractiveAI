<!-- Copyright (c) 2018-2022, RTE (http://www.rte-france.com)              -->
<!-- See AUTHORS.txt                                                       -->
<!-- This Source Code Form is subject to the terms of the Mozilla Public   -->
<!-- License, v. 2.0. If a copy of the MPL was not distributed with this   -->
<!-- file, You can obtain one at http://mozilla.org/MPL/2.0/.              -->
<!-- SPDX-License-Identifier: MPL-2.0                                      -->
<!-- This file is part of the OperatorFabric project.                      -->



<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Assistant CAB v2</title>
  <base href="/">

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style title="opfabRootStyle">
    /** 
Style parameters is define using css variables --params

Just two variables are set here , the complete style is set by the navbar.component.ts using global-style.service.ts.

This two values are used when navbar is not yet loaded

These two parameters are place in this file as the style should have a title parameter (it 's not possible to give a name for the style in the angular.json file). 

*/


    :root {
      --opfab-bgcolor: #262f3d;
      --opfab-bgcolor-darker: #262f3d;
      --opfab-text-color: white;
      --opfab-input-text-color: white;
      --opfab-form-border-color: #606267;
      --opfab-form-label-text-color: #bababa;
    }
  </style>

  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script>
    var selectedUseCase = "none";
    var token = window.localStorage.token;
    var opFabPort = "2002";
    var cabPort = "3200";
    var activeUser;
    var entities;
    var groups;
    var mapInitialized = false;
    var latitude;
    var longitude;
    var altitude;
    var authorizedUseCase;
    var map;
    var sncfMarker;
    var markers = {};
    var increasedLongitude = -4.09445;
    var tokenSynchronizeUrl = ""
    var msg_train = ', Jean votre superviseur, la présence d’un voyageur malade à bord nous oblige à marquer un arrêt supplémentaire en gare de  Poitiers pour permettre l’intervention des services de secours. Des informations complémentaires vous seront communiquées ultérieurement. Merci de votre attention.';
    var msg_train2 = ', Jean votre superviseur, merci à toute personne ayant des connaissances médicales de se faire connaître auprès de la borne d’appel.';
    var msgs_train = [msg_train,msg_train2];
    var trainIconFr = "/assets/images/icons/train_framboise.png";
    var train_ko = "/assets/images/icons/train_ko.png";
    var train_ok = "/assets/images/icons/train_ok.png";
    var SNCFseverities = {
        ACTION : train_ko,
        ALARM : trainIconFr,
      } 
    var planeMarker;
    var contextSNCF;
    var host;
    var traceHost;
    var tracePort = 5200;
    var assistNeverTriggered = true;
    checkTokenToMatchUseCase();

    function checkTokenToMatchUseCase(){
      if(window.location.host.includes("localhost")){
        tokenSynchronizeUrl = "http://192.168.211.95" + ":" + opFabPort + "/users/users/synchronizeWithToken";
        host = "http://192.168.211.95" + ":" + cabPort;
        traceHost = "http://192.168.211.95" + ":" + tracePort;
      }
      else{
        tokenSynchronizeUrl = "/users/users/synchronizeWithToken";
        host = "";
      }
      var request = new XMLHttpRequest();
      request.onreadystatechange= function () {
          if (request.readyState==4) {
            response = JSON.parse(request.responseText)
            activeUser = response.login;
            entities = response.entities;
            groups = response.groups;
            authorizedUseCase = entities[0];
            return entities[0];
          }
          console.log("token checked")
      }

      request.open("POST",tokenSynchronizeUrl, true);

      request.setRequestHeader("Accept","application/json");
      request.setRequestHeader("Authorization","Bearer "+token);
      request.send();
    }
    function orangeCtx(){
      document.getElementById("orange_ctx_container").innerHTML = "<img src='assets/images/orange_contexte_appx_y.png'>";
    }
    function selectUseCase(uc){
      if (uc == authorizedUseCase){
        grantedUseCase(authorizedUseCase);
      }else{
        alert("Error: You're not allowed to access this environment")
      }
    }
   
    function getRecommandations(){
      document.getElementById("sncf_button_grey").style.cursor = 'wait';
      setTimeout(getRecoWithTimer,10000);
    }
    function getRecoWithTimer(){
      document.getElementById("sncf_solution").hidden=false;
      document.getElementById("sncf_button_grey").style.cursor = 'unset';
    }
    function grantedUseCase(uc) {
      selectedUseCase = uc;
      if (uc != "DA"){
        document.documentElement.requestFullscreen();
      }
      console.log(uc + " selected as use case");
      switch (uc) {
        case "RTE":
          document.getElementById("rte_checkboxes").hidden = false;
          document.getElementById("assist").hidden = false;
          document.getElementById("assistOpTitle").classList.add("assistOpTitleDA");
          document.getElementById("assistOpTitle").classList.add("orange_theme");
          document.getElementById("feed-content").classList.add("orange_theme");
          document.getElementById("feed-content").style.position = "absolute";
          document.getElementById("feed-content").classList.add("feed-content_optimized");
          document.getElementById("feed-content").classList.add("rteNotifsE");
          document.getElementById("ctx_div").classList.add("orange_theme");
          document.getElementById("ctx_div").classList.add("rte_ctx_div");
          document.getElementById("opfab-card-list").classList.add("rteNotifs");
          document.getElementById("opfab-card-list").classList.add("opfab-card-list-RTE");
          document.getElementById("feed-content").classList.add("rteNotifs");
          document.getElementById("ctxImg").classList.add("rte_ctxImg");
          document.getElementById("assistOpTitle").style.top = "80px";
          document.getElementById("assistOpTitle").classList.add("assistOpTitle_rte");
          document.getElementById("feed-content").style.top = "70px";
          document.getElementById("empty_block").hidden = true;
          document.getElementById("ctxImg").hidden = false;
          document.getElementById("map").hidden = true;
          document.getElementById("notifs_RTE").hidden = false;
          document.getElementById("notifContainer").innerHTML = document.getElementById("notifContainer").innerHTML.replace("Notifications","Alertes");

          setInterval(() => {
            refreshCtxRTE();
          }, 30000);
          break;
        case "DA":
          getCoordinates();
          document.getElementById("dassault_div").hidden = false;
          document.getElementById("dassault_title").hidden = false;
          document.getElementById("dassaultBar").hidden = false;
          document.getElementById("dassaultBar2").hidden = false;
          document.getElementById("feed-content").style.position = "absolute";
          document.getElementById("feed-content").classList.add("feed-content_optimized")
          document.getElementById("assistOpTitle").classList.add("assistOpTitleDA");
          document.getElementById("assistOpTitle").style.overflowY = "scroll";
          document.getElementById("assistOpTitle").style.top = "80px";
          document.getElementById("opfab-card-list").style.overflowY = "hidden";
          document.getElementById("opfab-navbar-menu-feed").text = "CAB Dassault";
          document.getElementById("opfab-navbar-menu-menu1").text = "";
          document.getElementById("opfab-navbar-menu-feed").style.borderBottomStyle = "none";
          document.getElementById("of_timeline").style.backgroundColor = "black";
          document.getElementById("ctx_div").classList += " dassault_ctx_div";
          document.getElementById("notifs_DA").hidden = false;
          document.getElementById("opfab-feed-filter-btn-filter").hidden = true;
          document.getElementById("da_block_request").hidden = false;
          document.getElementById("of_timeline").style.zIndex = 5;
          document.getElementById("map").classList += " map_da";
          document.getElementById("notifContainer").innerHTML = document.getElementById("notifContainer").innerHTML.replace("Notifications","Failures");
          setInterval(() => {
            refreshCtxDA();
          }, 110);
          opfabStyle.setCss(opfabStyle.NIGHT_STYLE);
          setDANotifications();
          // mapDA();
          break;
        case "ORANGE":
          document.getElementById("opfab-navbar-menu-feed").text = "CAB Orange";
          document.getElementById("opfab-navbar-menu-menu1").text = "";
          document.getElementById("opfab-navbar-menu-feed").style.borderBottomStyle = "none";
          document.getElementsByClassName('opfab-navbar')[0].style.backgroundColor = "#4BB4E6"; //couleur topbar
          document.getElementById("opfab-navbar-menu-feed").style.color = "white";
          setTimeout(getOrangeIncidents,20000);
          document.getElementById("map").hidden = true;
          document.getElementById("correlation").hidden = false;
          document.getElementById("orange_assist").hidden = false;
          document.getElementById("orange_ctx").hidden = false;
          document.getElementById("assistOpTitle").classList.add("orange_theme");
          document.getElementById("assistOpTitle").classList.add("assist_sncf");
          document.getElementById("assistOpTitle").classList.add("assistOpTitle");
          document.getElementById("assistOpTitle").style.top = "80px";
          document.getElementById("assistOpTitle").style.overflow = "scroll";
          document.getElementById("feed-content").style.position = "absolute";
          document.getElementById("feed-content").style.marginTop = "0px";
          document.getElementById("feed-content").classList.add("orange_theme");
          document.getElementById("feed-content").classList.add("feed-content_override");
          document.getElementById("ctx_div").classList.add("orange_theme");
          document.getElementById("ctx_div").classList.add("sncf_ctx_div");
          document.getElementById("ctx_div").classList.add("sncf");
          document.getElementById("assistOpTitle").classList.add("sncf");
          document.getElementById("assistOpTitle").classList.add("assist_orange_overflow_override");
          document.getElementById("feed-content").classList.add("sncf");
          document.getElementById("notifContainer").innerHTML = document.getElementById("notifContainer").innerHTML.replace("Notifications","Incidents");
          break;
        case "SNCF":
          document.getElementById("opfab-navbar-menu-feed").text = "CAB SNCF";
          document.getElementById("opfab-navbar-menu-menu1").text = "";
          document.getElementsByClassName('opfab-navbar')[0].style.backgroundColor = "#009AA6"
          document.getElementById("opfab-navbar-menu-feed").style.color = "white"
          document.getElementById("opfab-navbar-menu-feed").style.borderBottomStyle = "none";
          // document.getElementById("ctx_div").style.marginLeft = "440px";
          document.getElementById("sncf_assist_nominal").hidden = false;
          document.getElementById("assist").hidden = false;
          document.getElementById("assistOpTitle").classList += " sncf assist_sncf assistOpTitle";
          document.getElementById("assistOpTitle").style.top = "80px";
          document.getElementById("feed-content").style.position = "absolute";
          document.getElementById("feed-content").style.marginTop = "0px";
          document.getElementById("sncfControl").hidden = false;
          document.getElementById("feed-content").classList += " sncf";
          document.getElementById("feed-content").classList.add("feed-content_override");
          document.getElementById("ctx_div").classList+= " sncf sncf_ctx_div"
          document.getElementById("map").classList += " map_sncf";
          setInterval(() => {
            refreshCtxSNCF();
          }, 110);
          mapSNCF();
          break;

      }
      document.getElementById("homescreen").style = "display:none";
      document.getElementById("assistOpTitle").hidden = false;
    }

    function getOrangeIncidents(){
      document.getElementById("orange_incidents").hidden = false;
    }
    function selectDassaultCtx(type) {
      switch (type) {
        case "dependances":
          document.getElementById("dependances").hidden = false;
          document.getElementById("synoptique").hidden = true;
          document.getElementById("carte").hidden = true;
          document.getElementById("map").hidden = true;
          document.getElementById("synoptic_back").hidden = true;
          break;
        case "carte":
          document.getElementById("dependances").hidden = true;
          document.getElementById("synoptique").hidden = true;
          document.getElementById("carte").hidden = false;
          document.getElementById("map").hidden = false;
          document.getElementById("synoptic_back").hidden = true;
          if (!mapInitialized) {
            initMap("Dassault");
            mapInitialized = true;
          }
          break;
        case "synoptique":
          document.getElementById("dependances").hidden = true;
          document.getElementById("synoptic_back").hidden = false;
          document.getElementById("synoptique").hidden = false;
          document.getElementById("carte").hidden = true;
          document.getElementById("map").hidden = true;
          break;

      }
    }
    function selectSNCFCtx(type) {
      switch (type) {
        case "incident":
          document.getElementById("map").hidden = true;
          document.getElementById("sncf_ctx").hidden=true;
          document.getElementById("sncf_ctx_materiel").hidden=true;
          document.getElementById("sncf_incident_infos").hidden=false;
          document.getElementById("history").hidden=false;
          document.getElementById("incident").classList.remove("toBlink");
          break;
        case "materiel":
          document.getElementById("map").hidden = true;
          document.getElementById("sncf_ctx").hidden=true;
          document.getElementById("sncf_ctx_materiel").hidden=false;
          document.getElementById("sncf_incident_infos").hidden=true;
          document.getElementById("history").hidden=true;
          document.getElementById("materiel").classList.remove("toBlink");
          break;
        case "voyageurs":
          document.getElementById("map").hidden = true;
          document.getElementById("sncf_ctx_materiel").hidden=true;
          document.getElementById("sncf_ctx").hidden=false;
          document.getElementById("sncf_incident_infos").hidden=true;
          document.getElementById("history").hidden=true;
          document.getElementById("voyageurs").classList.remove("toBlink");
          break;
        case "carte":
          document.getElementById("map").hidden = false;
          document.getElementById("sncf_ctx").hidden=true;
          document.getElementById("sncf_ctx_materiel").hidden=true;
          document.getElementById("history").hidden=true;
          document.getElementById("sncf_incident_infos").hidden=true;
          break;

      }
    }
    
    function displayStats(value){
      hideAllSynops()
      switch (value){
        case 'STAT':
          document.getElementById("STATUS_nominal").hidden = false;
          break;
        case 'ECS':
          document.getElementById("ECS_nominal").hidden = false;
          break;
        case 'ELEC':
          document.getElementById("ELEC_nominal").hidden = false;
          break;
        case 'FUEL':
          document.getElementById("FUEL_nominal").hidden = false;
          break;
        case 'HYD':
          document.getElementById("HYD_nominal").hidden = false;
          break;
        case 'BLD':
          document.getElementById("BLEED_nominal").hidden = false;
          break;
        case 'TEST':
          document.getElementById("TEST_nominal").hidden = false;
          break;
        case 'ENG':
          document.getElementById("ENGINE_nominal").hidden = false;
          break;
      }
    }

    function hideAllSynops(){
      var synops = ['STATUS','ECS','ELEC','FUEL','HYD','BLEED','TEST','ENGINE'];
      for (var synop=0;synop<synops.length;synop++){
        try {
          document.getElementById(synops[synop]).hidden= true;
        } catch (error) {
          console.log("unknown synop element")
        }
        try {
          document.getElementById(synops[synop]+"_nominal").hidden= true;
        } catch (error) {
          console.log("unknown synop nominal element")
        }
      }
    }
       
    function setDANotifications(){
      try {
              setCardsForDA();
              setDescsForDA();
            } catch (error) {
            }
            try {
              setSeverityForDA();
            } catch (error) {
            }
    }
    if (selectedUseCase!= "DA"){
      setInterval(() => {
        setCardsSeverity();
      }, 3000);
    }

    function setCardsForDA() {
      var cards = document.getElementsByClassName("card");
      for (var card = 0; card < cards.length; card++) {
          if (!cards[card].classList.contains("DA_Card") || !cards[card].classList.contains("light-card-detail-unselected-DA-MED")){
            cards[card].classList += " DA_Card light-card-detail-unselected-DA-MED";
          }
        }
      }
          
    function setSeverityForDA() {
      var severities = document.getElementsByClassName("card-severity")
      for(var severity = 0;severities.length;severity++){
            severities[severity].textContent="";
        }
      }
    function setDescsForDA() {
        var descs = document.getElementsByClassName("p-1");
        for(var desc = 0;descs.length;desc++){
            descs[desc].textContent="";
        }
    }

    function setCardsSeverity() {
      if (selectedUseCase == "SNCF"){
        var severities = document.getElementsByClassName("opfab-feed-list-card-severity")
        for (var severity = 0; severity < severities.length; severity++) {
           severities[severity].hidden = true
          }
          var descs = document.getElementsByClassName("p-1");
         var titles = document.getElementsByClassName("card-title")
         for (var titleSncf = 0; titleSncf < titles.length; titleSncf++) {
          titles[titleSncf].style.marginLeft = '40px'
        }
        for(var desc = 0;descs.length;desc++){
          try {
          descs[desc].hidden = true;
          } catch (error) {
            break;
          }
        }
      }
      var cards = document.getElementsByClassName("card");
      for (var card = 0; card < cards.length; card++) {
        cards[card].innerHTML = cards[card].innerHTML.replace("action ", "Sureté");
        cards[card].innerHTML = cards[card].innerHTML.replace("alarm ", "Sureté");
        cards[card].innerHTML = cards[card].innerHTML.replace("compliant ", "Routine ");
        cards[card].innerHTML = cards[card].innerHTML.replace("information ", "Routine ");
        if (selectedUseCase == "SNCF"){
          if (!cards[card].classList.contains("SNCF_card")){
            cards[card].classList.add("SNCF_Card");
            try {
              getCardContent(cards[card].getAttribute("data-urlid"));
            } catch (error) {
              console.log(error)
            }
          }
          //titre carte margé
          if (innerWidth > 1800){
            cards[card].children[0].style.marginLeft = '80px'
          }else{
            cards[card].children[0].style.marginLeft = '60px'
          }

          if (cards[card].classList.contains("light-card-detail-selected")){
            //carte selectionée classe SNCF
              cards[card].classList.add("sncf-light-card-selected");
              cards[card].classList.add("sncf-border-" + cards[card].attributes['severity'].value);
              cards[card].classList.remove("sncf-light-card-background-" + cards[card].attributes['severity'].value);
              cards[card].classList.add("sncfCard");
              cards[card].classList.remove("sncfCardNotSelected");
              cards[card].children[0].children[0].children[0].children[0].style.fontWeight = "100";
              if(assistNeverTriggered){
                document.getElementById("sncf_assist").hidden = false;
                assistNeverTriggered = false;
              }
          }
          if (cards[card].classList.toString().includes("light-card-detail-unselected")){
            //carte selectionée classe SNCF
              cards[card].classList.remove("sncf-light-card-selected");
            try {
              cards[card].classList.add("sncf-light-card-background-" + cards[card].attributes['severity'].value);
              cards[card].classList.remove("sncfCard");
              cards[card].classList.add("sncfCardNotSelected");
              cards[card].classList.remove("sncf-border-" + cards[card].attributes['severity'].value);
              } catch (error) {
                console.info("non concerné, sncf")
              }
          }
          if(cards[card].classList.toString().includes("light-card-detail-unread")){
            // carte non lue
            cards[card].style.color="white";
          }
          else if (cards[card].classList.toString().includes("light-card-background-"+ cards[card].attributes['severity'].value) 
          && cards[card].classList.toString().includes("light-card-detail-selected")
           || cards[card].classList.toString().includes("light-card-background-"+ cards[card].attributes['severity'].value) 
          && cards[card].classList.toString().includes("sncf-light-card-selected") ){
          }
        }else if (selectedUseCase == "RTE" && !cards[card].classList.toString().includes("light-card-border") && cards[card].classList.toString().includes("light-card-detail")){
            cards[card].classList += " light-card-background-" + cards[card].attributes['severity'].value;
            cards[card].classList += " title-light-card-border-white";
            cards[card].classList += " light-card-border-" + cards[card].attributes['severity'].value;
        }else if (selectedUseCase == "DA"){
          if (!cards[card].classList.toString().includes("light-card-background") && cards[card].classList.toString().includes("light-card-detail")){
            try {
              cards[card].classList += " light-card-background-" + cards[card].attributes['severity'].value;
              cards[card].classList += " light-card-background-" + cards[card].attributes['severity'].value + "_DA";
            } catch (error) {
              //nothing to catch, normal behavior 
            }

          }
      }else if (selectedUseCase == "RTE"){
          if (cards[card].classList.contains("light-card-detail-selected")){
              if(assistNeverTriggered){
                document.getElementById("rte_assist_nominal").hidden = false;
                assistNeverTriggered = false;
              }
          }
      }
    }
      if (selectedUseCase == "DA"){
        setDANotifications();
        if(assistNeverTriggered){
          document.getElementById("dassault_assist").hidden = false;
          assistNeverTriggered = false;
        }
      }
    }
    function getCardContent(id_card) {
      if (id_card != null){
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", host + "/cards/cards/"+id_card,false);
        xmlHttp.setRequestHeader("Authorization","Bearer "+token);
        xmlHttp.send(null);
        var response = JSON.parse(xmlHttp.responseText);
        lastTrain = response.card.data.metadata.id_train;
        lastSeverity = response.card.severity;
        updateTrainStatus(lastTrain,lastSeverity)
      }
    };

    function updateTrainStatus(id_train,severity){
      markers[id_train]._icon.src = SNCFseverities[severity]+"?time=" + new Date().getTime();
    }
    function refreshCtxRTE() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", host + "/cabcontext/api/v1/contexts?time=" + new Date().getTime(), false);
      xmlHttp.setRequestHeader("Authorization","Bearer "+token);
      xmlHttp.send(null);
      var response = JSON.parse(xmlHttp.responseText)[0].data.topology;
      document.getElementById("ctxImg").src = "data:image/png;base64," + response;
    };
    function refreshCtxDA() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", host + "/cabcontext/api/v1/contexts?time=" + new Date().getTime(), false);
      xmlHttp.setRequestHeader("Authorization","Bearer "+token);
      xmlHttp.send(null);
      var response = JSON.parse(xmlHttp.responseText);
      setAndUpdateDAMarkersOnMap(response[0].data)
    };
    function getCorrelations() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", host + "/cab_correlation/api/v1/correlation?size=1", false);
      xmlHttp.setRequestHeader("Authorization","Bearer "+token);
      xmlHttp.send(null);
      var response = JSON.parse(xmlHttp.responseText);
      try {
        document.getElementById("orange_assist").innerHTML += Object.keys(response[0].data).length + " corrélations trouvées.";
      } catch (error) {
        document.getElementById("orange_assist").innerHTML += "Aucune corrélation trouvée.";
      }
      Object.entries(response[0].data).forEach(entry => {
        const [key, value] = entry;
        document.getElementById("orange_assist").innerHTML += '<span class="correlation"><b>' + key + '</b><button class="orange_button_theme">' + value[key] + '</button></span>'
      });
    };


    function refreshCtxSNCF() {
      var xmlHttp = new XMLHttpRequest();
      xmlHttp.open("GET", host + "/cabcontext/api/v1/contexts?time=" + new Date().getTime(), false);
      xmlHttp.setRequestHeader("Authorization","Bearer "+token);
      xmlHttp.send(null);
      var response = JSON.parse(xmlHttp.responseText);
      var trains = response[0].data.trains;
      contextSNCF = response[0].data;
      setAndUpdateSNCFMarkersOnMap(trains);
    };

    function getRecommandationSNCF(){
        document.getElementById('sncf_solution').innerHTML = "";
        var bodyHTML;
        var xhr = new XMLHttpRequest();
        xhr.withCredentials = true;
        xhr.addEventListener("readystatechange", function() {
          if(this.readyState === 4) {
            var recoSNCF = JSON.parse(this.responseText).recommandation;
            console.log(JSON.parse(this.responseText))
            document.getElementById('sncf_solution').innerHTML += recoSNCF;
          }
        });
        xhr.open("POST", host +  "/cab_recommendation/api/v1/recommendation");
        xhr.setRequestHeader("Content-Type", "application/json");
        xhr.setRequestHeader("Authorization", "Bearer " + window.localStorage.token);
        var recommendationBody = 
          { context : contextSNCF,
            event : jsonEventObject
          }
        xhr.send(JSON.stringify(recommendationBody));
        }
    
    function getLastCard() {
        var xmlHttp = new XMLHttpRequest();
        xmlHttp.open("GET", host + "/cards/cards/"+ document.getElementsByClassName("card")[0].getAttribute("data-urlid"),false);
        xmlHttp.setRequestHeader("Authorization","Bearer "+ window.localStorage.token);
        xmlHttp.send(null);
        var response = JSON.parse(xmlHttp.responseText);
        var eventAttributes = response.card.data.metadata;
        console.log(eventAttributes);
        jsonEventObject = eventAttributes;
    };
    function traceInHistory(traceType,useCase,data){
      var data = JSON.stringify({
        "data": {data},
        "date": new Date(),
        "step": traceType,
        "use_case": useCase
      });

      var xhr = new XMLHttpRequest();
      xhr.withCredentials = true;

      xhr.addEventListener("readystatechange", function() {
        if(this.readyState === 4) {
          console.info("TRACE",this.responseText);
        }
      });

      xhr.open("POST", traceHost + "/api/v1/traces");
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(data);
      console.log(data)
    }

    function askCab(){
      traceInHistory("ASKFORHELP",authorizedUseCase,null);
      switch(authorizedUseCase){
        case "SNCF":
          document.getElementById("sncf_assist_nominal").hidden = true;
          document.getElementById("sncf_assist_full").hidden = false;
          document.getElementById("recos_sncf").hidden = false;
          getLastCard();
          getRecommandationSNCF();
        break;
        case "RTE":
        document.getElementById("rte_assist_nominal").hidden = true;
        break;
      }
      }
    function applyRecommandation(){
      traceInHistory("AWARD",authorizedUseCase,jsonEventObject);
      switch(authorizedUseCase){
        case "SNCF":
          document.getElementById("sncf_assist_nominal").hidden = true;
          document.getElementById("sncf_assist_full").hidden = false;
          document.getElementById("recos_sncf").hidden = false;
        break;
        case "RTE":
        document.getElementById("rte_assist_nominal").hidden = true;
        break;
      }
      }

      
  </script>


  <link rel="manifest" href="manifest.webmanifest">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI=" crossorigin="" />
  <meta name="theme-color" content="#1976d2">
</head>

<body class="opfab-colors" id="bodyopfab" style="height:auto">

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>

    function getCoordinates(){
      var request = new XMLHttpRequest();
      request.onreadystatechange= function () {
          if (request.readyState==4) {
            try {
            response = JSON.parse(request.responseText)
            //temporary fix for coordinates
              latitude = response[0].data.Latitude;
              longitude = response[0].data.Longitude;
              altitude = response[0].data.Altitude;
            } catch (error) {
              latitude = 47.9948;
              longitude = -4.09245;
            }
          
            console.log(response)
          }
      }
      request.open("GET","/cabcontext/api/v1/contexts", true);
      request.setRequestHeader("Accept","application/json");
      request.setRequestHeader("Authorization","Bearer "+token);
      request.send();
    }

    function mapSNCF(){
      mapZoom = 6;
          initialLayer = "http://{s}.tile.osm.org/{z}/{x}/{y}.png";
          railwayLayer = "https://{s}.tiles.openrailwaymap.org/standard/{z}/{x}/{y}.png";
          defaultLatitude = 44.837789;
          defaultLongitude = -0.57918;
          map = L.map('map', {
            center: [defaultLatitude, defaultLongitude],
            zoom: mapZoom
          });
          var baseLayer = L.tileLayer(initialLayer).addTo(map);
          var topLayer = L.tileLayer(railwayLayer).addTo(map);

    }
    function mapDA(){
      mapZoom = 8;
          mapLayer = "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png";
          if(latitude === undefined || longitude === undefined){
              latitude = 47.9948;
              longitude = -4.09245;
          }
          map = L.map('map', {
            center: [latitude,longitude],
            zoom: mapZoom
          });
          L.tileLayer(mapLayer).addTo(map);
    }
    function setAndUpdateSNCFMarkersOnMap(data) {
      data.forEach(function (train) {
        if (!markers.hasOwnProperty(train.id_train)) {
          if(train.failure){
        iconUrl = "/assets/images/icons/train_ko.png"
        }else{
          iconUrl = "/assets/images/icons/train_ok.png"
        }
        let trainIconSrc = {iconUrl,iconSize: [20, 20]}
          let trainIcon = L.icon(trainIconSrc);
          let iconOptions = {title: train.id_train,draggable: false,icon: trainIcon}
          markers[train.id_train] = new L.Marker([train.latitude, train.longitude],iconOptions).addTo(map).on('click', markerOnClick);
          markers[train.id_train].attributes = train;
          markers[train.id_train].previousLatLngs = [];
        } else {
            if(train.latitude == null && train.longitude == null){
              lastLat = markers[train.id_train].previousLatLngs[markers[train.id_train].previousLatLngs.length-1].lat
              lastLong = markers[train.id_train].previousLatLngs[markers[train.id_train].previousLatLngs.length-1].lng
              markers[train.id_train].setLatLng([lastLat, lastLong]);
            }
            else {
              markers[train.id_train].previousLatLngs.push(markers[train.id_train].getLatLng());
              markers[train.id_train].setLatLng([train.latitude, train.longitude]);
            }
          }
      });
}
    function setAndUpdateDAMarkersOnMap(data) {
      planeMarker.setLatLng([data.Latitude, data.Longitude]);
    }

    function markerOnClick(e){
      markerOptions = e.sourceTarget.options;
      markerTitle = markerOptions.title;
      nb_passengers_connection = markers[markerTitle].attributes.nb_passengers_connection;
      nb_passengers_onboard = markers[markerTitle].attributes.nb_passengers_onboard;
      speed = markers[markerTitle].attributes.speed;
      map.setView([e.sourceTarget._latlng.lat,e.sourceTarget._latlng.lng],13)
      document.getElementById("sncf_ctx").innerHTML = 
      
      "<div id='data_train'>"
        +'<div id="train_infos">' + "TGV n° : " + markerTitle +"<br>"
        + "Vitesse : " + speed + "km/h" +"<br>"
        + "Direction : N/A" + "<br>"
        + "Voyageurs à bord  " + nb_passengers_onboard +"<br>"
        + "Voyageurs voiture  <br>"
        + "Température int. <br> "
      + "</div>"
      + '<div id="sncf_indice">'
      +'<img id="img_indice" src="assets\/images\/rame_indice.png">'
      +'</div></div>'
      + "<span style='margin-top:5px'><b>Communication avec la rame </b></span>"
      + '<div id="train_welcome"><img src="assets\/images\/train_passengers.png"><span id="txt_passengers" style="margin-left:5px;border: 1px solid">' + 
        'Chers clients  du train '+ markerTitle + msgs_train[Math.floor(Math.random() * (1 - 0 + 1) + 0)] + '</span></div>';
        
      document.getElementById("sncf_ctx_materiel").innerHTML =
      '<b>Etat de la râme </b><br> '+
      '<div id="train_infos">'
      // + "TGV n° : " + markerTitle +"<br>"
      + "Point kilométrique : " + 'N/A' +"<br>"
      + "Vitesse : " + speed + "km/h" +"<br>"
      + "Prochain arrêt : N/A" + "<br>"
      + "Destination : N/A" + "<br>"
      + "Voyageurs à bord : " + nb_passengers_onboard
      + "</div>";
      document.getElementById("materiel").classList.add("toBlink");
      document.getElementById("voyageurs").classList.add("toBlink");
      markers[markerTitle].bindPopup(markerOptions.title + "<br> Vitesse: " + speed + " km/h" );
      
    }

    function initMap(usecase) {

      switch (usecase) {
        case 'Dassault':
          mapZoom = 8;
          mapLayer = "https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png";
          // valers par défaut si pas de contexte
          if(latitude === undefined || longitude === undefined){
              latitude = 47.9948;
              longitude = -4.09245;
          }
          var map = L.map('map', {
            center: [latitude,longitude],
            zoom: mapZoom
          });
          L.tileLayer(mapLayer, {
          }).addTo(map);
          let planeIcon = {
            iconUrl: "assets/images/plane_40x40.png",
            iconSize: [40, 40]
          }
          let myIcon3 = L.icon(planeIcon);
          let iconOptions3 = {
            draggable: false,
            icon: myIcon3
          }

          planeMarker = new L.Marker([latitude, longitude], iconOptions3);
          planeMarker.addTo(map).bindPopup(iconOptions3.title)
          break;
      }
      console.log("map init OK")
    }

    function displaySwal(){
      Swal.fire({
      html:'<span style="font-size:20px">Paramétrage service corrélation</span><br>'
      + '<div id="box_methode_calcul"><b>Choix de la méthode de calcul</b>'
      + '<div style="width:100%;"><br><form>'
      + '<input name="choice" type="radio"><label style="width:70%">Méthode 1</label>'+'<img class="reduced" src="./assets/images/!.png">'+'<br><hr>'
      + '<input name="choice" type="radio"><label style="width:70%">Méthode 2</label>'+'<img class="reduced" src="./assets/images/!.png"><br>'
      + '</form></div><br>'
      + '<b>Choix des KPIs</b>'
      + '<div style="width:100%;"><br><form>'
      + '<input name="choiceKPI" type="radio"><label style="width:70%">Nombre de pages lentes</label>'+'<img class="reduced" src="./assets/images/!.png">'+'<br><hr>'
      + '<input name="choiceKPI" type="radio"><label style="width:70%">Temps de réponse</label>'+'<img class="reduced" src="./assets/images/!.png"><hr>'
      + '<input name="choiceKPI" type="radio"><label style="width:70%">Nombre de requêtes</label>'+'<img class="reduced" src="./assets/images/!.png">'+'<br><hr>'
      + '<input name="choiceKPI" type="radio"><label style="width:70%">Nombre d\'erreurs 4xx-5xx</label>'+'<img class="reduced" src="./assets/images/!.png"><hr>'
      + '<input name="choiceKPI" type="radio"><label style="width:70%">Taux de pages lentes</label>'+'<img class="reduced" src="./assets/images/!.png"><hr>'
      + '<input name="choiceKPI" type="radio"><label style="width:70%">Taux d\'érreurs</label>'+'<img class="reduced" src="./assets/images/!.png"><hr>'
      + '</form></div>'
      + '</div>'
      + '<div id="orangeTimeSelector">'
          +'<b>Fenêtre de temps</b>'
          +'<br>'
          +'<input type="range" id="slider" name="temp" list="values" />'
          +'<datalist id="values">'
            +'<option value="15" label="15mn"></option>'
            +'<option value="60" label="1h"></option>'
            +'<option value="120" label="2h"></option>'
            +'<option value="180" label="3h"></option>'
            +'<option value="240" label="4h"></option>'
            +'<option value="300" label="5h"></option>'
          +'</datalist>'
        +'</div>'
      + '<button onclick="Swal.close();getCorrelations()">Calculer Corrélation</button>',
      showConfirmButton: false
    })
  }
  </script>
  <div id="assistOpTitle" style="font-size: 18px; color: grey;position: absolute;top: 90px;" hidden>
  <!-- <div id="assistOpTitle" style="font-size: 18px; color: grey;position: absolute;left: 1178px;top: 90px;" hidden> -->
    <b id="assist" hidden>Assistance à l'opérateur</b>
    <b id="correlation" hidden>Corrélations</b>
    <b id="dassault_title" hidden>Assistance</b>
    <div id="sncf_assist" hidden>
      <div id ="sncf_assist_nominal" hidden> Comment puis-je vous aider? <br>
        <button class="sncf_button" onclick="askCab()"><b>Solliciter CAB</b></button>
      </div>
      <div id="sncf_assist_full" hidden>Recommandations de solutions
        <div id="sncf_actions">
          <button class="sncf_button_assist"><b>Nb. Clients</b></button>
          <button class="sncf_button_assist"><b>Retard</b></button>
          <button class="sncf_button_assist"><b>Coût</b></button>
        </div>
        <br>
        <div>
          <div id="recos_sncf" hidden>
          </div>
          <div style="margin-left: 130px;margin-bottom: 5px;">
            <!-- <button class="sncf_button"><b>Choisir</b></button> -->
          </div>
        </div>
        <button id="sncf_button_grey" class="sncf_button_grey" style="float:right" onclick="getRecommandations()">Je propose une solution</button>
      </div>
      <div id="sncf_solution" hidden style="margin-top: 50px">
        <input type="checkbox" id="sol1" value="sol1">
        <label for="sol1">Retenue TGV 7652 à Angoulême</label>
        <hr>
        <input type="checkbox" id="sol2" value="sol2">
        <label for="sol2">Retenue TGV 5440 à Angoulême</label>
        <hr>
      </div>
    </div>
    <div id="orange_assist" hidden>
      <div id="orange_headers" style="display:flex">
        <div><button id="canari" class="orange_button_theme histo_tab canari" onclick='document.getElementById("stats_temps").hidden=true;document.getElementById("correlation_app_y").hidden=false'>Historique CANARI</button></div>
        <div><button class="orange_button_theme stats_tab stats" onclick='document.getElementById("stats_temps").hidden=false;document.getElementById("correlation_app_y").hidden=true;displaySwal()'>Statistiques</button></div>
      </div>
      <div id="stats_temps" hidden>
        <div id="orangeTimeSelector">
          <b>Fenêtre de temps</b>
          <br>
          <input type="range" id="slider" name="temp" list="values" />
          <datalist id="values">
            <option value="15" label="15mn"></option>
            <option value="60" label="1h"></option>
            <option value="120" label="2h"></option>
            <option value="180" label="3h"></option>
            <option value="240" label="4h"></option>
            <option value="300" label="5h"></option>
          </datalist>
        </div>
        <button id="display_result" onclick="">Afficher le résultat</button>
      </div>
      <div id="correlation_app_y" hidden>
        <div id="orange_correlation_notif">Correlation avec <button 
          class="orange_button orange_button_purple" 
          onclick="document.getElementById('orange_correlation_desc').hidden=false">App Y</button></div>
        <div id="orange_correlation_desc">
          <b>Incidents passés sur l'App X en corrélation avec l'App Y</b><br>
          Fiche CANARI APPX & Y <br>
          28/12/2023<br>
          <hr>
          Fiche CANARI APPX & Y<br>
          14/11/2023<br>
          <hr>
          <b>Action de rétalissement passées sur l'App X</b><br>
          Description de l'action de rétablissement<br>
          28/12/2023 
          <hr>
        </div>
      </div>
    </div>
    <div id="dassault_assist" hidden>
      <div id="da_bloc_content">
        <div class = "da_assist" id="noevent_da"> <img src='assets/images/no_event_da.png'></div>
          <div class = "da_assist" id="high_procedure" hidden>
            <img src="assets\images\endofprocedure_da.png">
          </div>
          <div class = "da_assist" id="pdv_da" hidden>
            <img src="assets\images\pdv_da.png">
          </div>
      </div>
      <div id="da_block_request" hidden></div>
    </div>
    <div id = "rte_assist" class="opfab-card-template-rendering" style="display:none;font-size: 13px;width: 520px;">
    </div>
    <div id ="rte_assist_nominal" hidden><img style="width:100%" src="assets/images/assistop_colored.png"><br>
      <button class="sncf_button" style="margin-left: 100px" onclick="askCab()"><b>Solliciter CAB</b></button>
    </div>
    <div id="opfab-div-card-template-alarm" class="opfab-card-template-rendering" style="display:none;font-size: 13px;width: 520px;">
      <b style="color:black">Parades</b><br><div><span class="rtePrd">Parade topologique: prise de schéma au poste 26 </span><button class="rteBtn">Appliquer Parade</button><br>
      <span> LTTD: 5min</span>
</div>
      <!-- <span style="border-left:2px solid lightgrey"></span> -->
      <hr>
      <div><span class="rtePrd">Parade topologique : Prise de schéma au poste 16 </span><button class="rteBtn">Appliquer Parade</button><br>
        <span> LTTD: 5min</span>
       </div>
      <hr>
      <div><span class="rtePrd">Parade topologique: prise de schéma au poste 28</span><button class="rteBtn">Appliquer Parade</button><br>
      <span>LTTD: 5min</span></div>
      <hr>

      <div><span class="rtePrd">Changer de bus</span><button class="rteBtn">Appliquer Parade</button><br>
      </div>
    </div>
    <div id="opfab-div-card-template-alarm-second" class="opfab-card-template-rendering" style="display:none;font-size: 13px;width: 520px;">
      <b style="color:black">Parades</b><br><div><span class="rtePrd">Parade topologique: prise de schéma au poste 16 </span><button class="rteBtn">Appliquer Parade</button><br>
      <span> LTTD: 5min</span>
</div>
      <!-- <span style="border-left:2px solid lightgrey"></span> -->
      <hr>
      <div><span class="rtePrd">Parade topologique : Prise de schéma au poste 26 </span><button class="rteBtn">Appliquer Parade</button><br>
        <span> LTTD: 5min</span>
       </div>
      <hr>
      <div><span class="rtePrd">Parade injection: redispatch de source de production</span><button class="rteBtn">Appliquer Parade</button><br>
      <span>LTTD: 5min</span></div>
      <hr>

      <div><span class="rtePrd">Changer de bus</span><button class="rteBtn">Appliquer Parade</button><br>
      </div>
    </div>
    <div id="opfab-div-card-template-security" class="opfab-card-template-rendering" style="display:none">
    <b style="color:black">Parades</b><br>
    <span>Aucune parade trouvée pour cet évènement</span>
    <hr>
    <div>
      Action suggérée - réaliser une étude complémentaire
      <button class="rteBtn">Utiliser l'outil d'étude</button>
    </div>
    </div>
    <div id="opfab-div-card-template-noparades" class="opfab-card-template-rendering" style="display:none">
      <b style="color:black">Parades</b><br>
      <span>Aucune parade trouvée pour cet évènement</span>
    </div>
    <div id="opfab-div-card-template-agent" class="opfab-card-template-rendering" style="display:none">
      <b style="color:black">Parades</b><br>
      <b style="font-size: 15px">Je ne suis pas en mesure de vous fournir une assistance pour cet évènement </b>
    </div>

  </div>
  <of-root></of-root>
  <noscript>Please enable JavaScript to continue using this application.</noscript>
</body>

</html>