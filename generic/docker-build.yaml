
variables:
  DOCKER_REGISTRY: "harbor.irtsysx.fr"
  DOCKER_CONTEXT: "./backend/"
  DOCKERFILE: "generic/Dockerfile"
  IMAGE_NAME: ""
  IMAGE_VERSION: ""

.docker-build:
  stage: build_dev
  interruptible: true
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"${DOCKER_REGISTRY}\":{\"username\":\"${HARBOR_USER}\",\"password\":\"${HARBOR_PWD}\",\"auth\":\"$(printf "%s:%s" "${HARBOR_USER}" "${HARBOR_PWD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "${DOCKER_CONTEXT}"
      --dockerfile "${DOCKERFILE}"
      --compressed-caching=false
      --destination "$DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_VERSION"
  rules:
    - if: $CI_COMMIT_BRANCH == "test-ci"
      when: never
    - if: $CI_COMMIT_BRANCH == "develop"


.docker-build-common:
  stage: build_common
  interruptible: true
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  script:
    - echo "{\"auths\":{\"${DOCKER_REGISTRY}\":{\"username\":\"${HARBOR_USER}\",\"password\":\"${HARBOR_PWD}\",\"auth\":\"$(printf "%s:%s" "${HARBOR_USER}" "${HARBOR_PWD}" | base64 | tr -d '\n')\"}}}" > /kaniko/.docker/config.json
    - /kaniko/executor
      --context "./backend/cab_common"
      --build-arg "PYTHON_TAG=${PYTHON_TAG}"
      --compressed-caching=false
      --destination "$DOCKER_REGISTRY/$IMAGE_NAME:$IMAGE_VERSION"
  rules:
    - if: $CI_COMMIT_BRANCH == "test-ci"
      when: never
    - if: $CI_COMMIT_BRANCH == "develop"

