# Variables:
#  HARBOR_USER -> gitlab settings CI/CD Variables
#  HARBOR_PWD -> gitlab settings CI/CD Variables
#  DOCKER_REGISTRY -> This repo .gitlab-ci.yml file
#  APP_VERSION -> This repo .gitlab-ci.yml file
#  CHART_VERSION -> This repo .gitlab-ci.yml file

variables:
  CONTEXT: "chart"
  CHART: "cab-assistant-platform"

.package-helm:
  stage: package
  image: alpine/helm:3.12.2
  interruptible: true
  before_script:
    - echo "${CONTEXT}, ${CHART}"
    - helm repo add --username=${HARBOR_USER} --password=${HARBOR_PWD} cabrepo https://${DOCKER_REGISTRY}/chartrepo/cab
    - helm plugin install https://github.com/chartmuseum/helm-push
  script:
    - cd ${CONTEXT}
    - helm package --app-version ${APP_VERSION} --version ${CHART_VERSION} ${CHART}
    - cd chart && PACKAGE=$(ls *.tgz) && cd ../
    - echo "${PACKAGE}"
    - tar -xzvf chart/${PACKAGE} -C /tmp
    - cd /tmp/chart/
    - tar -czvf ${PACKAGE} ${CHART}
    - pwd && ls -alrth && tar -tvf ${PACKAGE}
    - helm cm-push ${PACKAGE} cabrepo
  rules:
    - if: $CI_COMMIT_BRANCH == "test-ci"
    - if: $CI_COMMIT_BRANCH == "develop"

