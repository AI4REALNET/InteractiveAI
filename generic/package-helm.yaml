# Variables:
#  HARBOR_USER -> gitlab settings CI/CD Variables
#  HARBOR_PWD -> gitlab settings CI/CD Variables
#  DOCKER_REGISTRY -> This repo .gitlab-ci.yml file
#  APP_VERSION -> This repo .gitlab-ci.yml file
#  CHART_VERSION -> This repo .gitlab-ci.yml file

variables:
  CONTEXT: "chart"
  CHART: "cab-assistant-platform"

.package-helm:
  stage: package
  image:
    name: alpine/k8s:1.28.1
  interruptible: true
  before_script:
    - helm repo add --username=${HARBOR_USER} --password=${HARBOR_PWD} cabrepo https://${DOCKER_REGISTRY}/chartrepo/cab
  script:
    - cd ${CONTEXT}
    - helm package --app-version ${APP_VERSION} --version ${CHART_VERSION} ${CHART}
    - sleep 777
    - PACKAGE=$(ls *.tgz)
    - echo "${PACKAGE}"
    - helm cm-push ${PACKAGE} cabrepo
  rules:
    - if: $CI_COMMIT_BRANCH == "test-ci"
    - if: $CI_COMMIT_BRANCH == "develop"

