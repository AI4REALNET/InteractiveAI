# Variables:
#  HARBOR_USER -> gitlab settings CI/CD Variables
#  HARBOR_PWD -> gitlab settings CI/CD Variables
#  DOCKER_REGISTRY -> This repo .gitlab-ci.yml file
#  APP_VERSION -> This repo .gitlab-ci.yml file
#  CHART_VERSION -> This repo .gitlab-ci.yml file

variables:
  CONTEXT: "chart"
  CHART: "cab-assistant-platform"

.package-helm:
  stage: package
  image:
    name: debian:bookworm-slim
  interruptible: true
  before_script:
    - apt update && apt install -y curl git
    - curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
    - helm repo add --username=${HARBOR_USER} --password=${HARBOR_PWD} cabrepo https://${DOCKER_REGISTRY}/chartrepo/cab
    - helm plugin install https://github.com/chartmuseum/helm-push
  script:
    - cd ${CONTEXT}
    - helm package --app-version ${APP_VERSION} --version ${CHART_VERSION} ${CHART}
    - PACKAGE=$(ls *.tgz)
    - echo "${PACKAGE}"
    - helm cm-push ${PACKAGE} cabrepo
  rules:
    - if: $CI_COMMIT_BRANCH == "test-ci"
    - if: $CI_COMMIT_BRANCH == "develop"

